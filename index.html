<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkillTree RPG</title>
  <!-- React + ReactDOM + Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa7b2; --accent:#4fd1c5;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{margin:0;background:linear-gradient(180deg,#061021,#081428);color:#e6eef6;min-height:100vh}
    .app{max-width:1100px;margin:0 auto;padding:12px}
    .topnav{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .topnav a{color:var(--accent);text-decoration:none}
    .auth-page, .home{padding:18px;background:var(--glass);border-radius:10px}
    .auth-form{display:flex;flex-direction:column;gap:8px;max-width:320px}
    .auth-form input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .btn{background:var(--accent);color:#012; padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.small{padding:6px 8px;font-size:13px}
    .err{color:#ff7b7b}
    .dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .dash-main{display:flex;gap:12px;flex-direction:column}
    .leftpanel{width:100%}
    @media(min-width:900px){ .dash-main{flex-direction:row} .leftpanel{width:360px} .game-area{flex:1} }
    .profile-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:10px}
    .skilltree-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    .skill-svg-wrap{width:100%;height:220px;background:linear-gradient(180deg,#08192a,#071116);border-radius:8px;padding:8px}
    .skill-svg-wrap svg{width:100%;height:100%}
    .game-container{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px}
    .game-hud{display:flex;gap:12px;justify-content:space-between}
    .enemy-card{margin-top:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .game-buttons{display:flex;gap:8px;margin-top:8px}
    .game-log{margin-top:12px;max-height:180px;overflow:auto}
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

const {
  BrowserRouter,
  Routes,
  Route,
  Link,
  Navigate,
  useNavigate
} = ReactRouterDOM;

// Auth context
const AuthContext = React.createContext();
function useAuth(){ return React.useContext(AuthContext); }
async function sha256(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function AuthProvider({children}){
  const [user, setUser] = React.useState(null);
  React.useEffect(()=>{
    const saved = localStorage.getItem('currentUser');
    if(saved) setUser(JSON.parse(saved));
  },[]);
  async function signup({username,password}){
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    if(users.find(u=>u.username===username)) throw new Error('Username taken');
    const pwHash = await sha256(password);
    const newUser = { username, pwHash, createdAt: Date.now(), profile:{level:1,xp:0,stats:{hp:100,attack:10}}, skills:{} };
    users.push(newUser);
    localStorage.setItem('users',JSON.stringify(users));
    localStorage.setItem('currentUser',JSON.stringify({username}));
    setUser({username});
  }
  async function login({username,password}){
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const pwHash = await sha256(password);
    const found = users.find(u=>u.username===username && u.pwHash===pwHash);
    if(!found) throw new Error('Invalid credentials');
    localStorage.setItem('currentUser',JSON.stringify({username}));
    setUser({username});
  }
  function logout(){ localStorage.removeItem('currentUser'); setUser(null); }
  function updateUserData(patch){
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const idx = users.findIndex(u=>u.username===user.username);
    if(idx === -1) return;
    users[idx] = {...users[idx], ...patch};
    localStorage.setItem('users',JSON.stringify(users));
  }
  function getFullUser(){
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    return users.find(u=>u.username===user?.username) || null;
  }
  return <AuthContext.Provider value={{user,signup,login,logout,updateUserData,getFullUser}}>{children}</AuthContext.Provider>;
}

// Components
function ProtectedRoute({children}){
  const { user } = useAuth();
  if(!user) return <Navigate to="/login" replace />;
  return children;
}
function Home(){
  return <div className="home">
    <h1>SkillTree RPG</h1>
    <p>Mobile-friendly, offline, localStorage-based.</p>
    <div style={{display:'flex',gap:10}}>
      <Link to="/signup" className="btn">Sign up</Link>
      <Link to="/login" className="btn">Log in</Link>
    </div>
  </div>;
}
function Signup(){
  const { signup } = useAuth();
  const [username,setUsername]=React.useState('');
  const [pw,setPw]=React.useState('');
  const [err,setErr]=React.useState('');
  const nav = useNavigate();
  async function submit(e){
    e.preventDefault();
    setErr('');
    try{ await signup({username,password:pw}); nav('/dashboard'); }
    catch(ex){ setErr(ex.message); }
  }
  return <div className="auth-page">
    <h2>Create Account</h2>
    <form onSubmit={submit} className="auth-form">
      <input required value={username} onChange={e=>setUsername(e.target.value)} placeholder="username"/>
      <input required value={pw} onChange={e=>setPw(e.target.value)} placeholder="password" type="password"/>
      <button type="submit">Sign Up</button>
      {err && <div className="err">{err}</div>}
    </form>
    <div className="foot">Already? <Link to="/login">Log in</Link></div>
  </div>;
}
function Login(){
  const { login } = useAuth();
  const [username,setUsername]=React.useState('');
  const [pw,setPw]=React.useState('');
  const [err,setErr]=React.useState('');
  const nav = useNavigate();
  async function submit(e){
    e.preventDefault();
    setErr('');
    try{ await login({username,password:pw}); nav('/dashboard'); }
    catch(ex){ setErr(ex.message); }
  }
  return <div className="auth-page">
    <h2>Log in</h2>
    <form onSubmit={submit} className="auth-form">
      <input required value={username} onChange={e=>setUsername(e.target.value)} placeholder="username"/>
      <input required value={pw} onChange={e=>setPw(e.target.value)} placeholder="password" type="password"/>
      <button type="submit">Log In</button>
      {err && <div className="err">{err}</div>}
    </form>
    <div className="foot">New? <Link to="/signup">Create account</Link></div>
  </div>;
}
function Dashboard(){
  const { logout, getFullUser } = useAuth();
  const profile = getFullUser()?.profile || {level:1,xp:0,stats:{hp:100,attack:10}};
  return <div className="dashboard">
    <header className="dash-header">
      <h2>RPG Dashboard</h2>
      <button onClick={logout} className="btn small">Logout</button>
    </header>
    <main className="dash-main">
      <aside className="leftpanel">
        <div className="profile-card">
          <h3>{getFullUser()?.username}</h3>
          <div>Level: {profile.level} XP: {profile.xp}</div>
          <div>HP: {profile.stats.hp} Attack: {profile.stats.attack}</div>
        </div>
        <SkillTree/>
      </aside>
      <section className="game-area"><GameArea/></section>
    </main>
  </div>;
}

// Skill Tree
const NODES = [
  { id:'s1', x:20, y:10, title:'Strike', cost:1, prereq:[] },
  { id:'s2', x:50, y:25, title:'Power Attack', cost:2, prereq:['s1'] },
  { id:'s3', x:80, y:10, title:'Quick Step', cost:1, prereq:[] },
  { id:'s4', x:50, y:55, title:'Defense', cost:1, prereq:['s1'] },
  { id:'s5', x:50, y:80, title:'Berserk', cost:3, prereq:['s2','s4'] },
];
function SkillTree(){
  const { getFullUser, updateUserData } = useAuth();
  const [unlocked,setUnlocked]=React.useState({});
  const username = getFullUser()?.username;
  React.useEffect(()=>{
    const saved = getFullUser()?.skills || {};
    setUnlocked(saved);
  },[username]);
  function canUnlock(node){
    if(unlocked[node.id]) return false;
    return node.prereq.every(pid=>unlocked[pid]);
  }
  function unlock(node){
    if(!canUnlock(node)) return;
    const newUnlocked = {...unlocked, [node.id]:true};
    setUnlocked(newUnlocked);
    updateUserData({skills:newUnlocked});
    const full = getFullUser();
    const stats = {...full.profile.stats};
    if(node.id==='s1') stats.attack += 3;
    if(node.id==='s2') stats.attack += 6;
    if(node.id==='s3') stats.hp += 10;
    if(node.id==='s4') stats.hp += 20;
    if(node.id==='s5'){ stats.attack += 12; stats.hp += 30; }
    const profile = {...full.profile, stats};
    updateUserData({profile});
  }
  return <div className="skilltree-card">
    <h4>Skill Tree</h4>
    <div className="skill-svg-wrap">
      <svg viewBox="0 0 100 100">
        {NODES.map(n=>n.prereq.map(pid=>{
          const p = NODES.find(x=>x.id===pid);
          if(!p) return null;
          return <line key={pid+'-'+n.id} x1={p.x} y1={p.y} x2={n.x} y2={n.y} stroke="#777" strokeWidth="0.6"/>;
        }))}
        {NODES.map(n=>{
          const isUnlocked = !!unlocked[n.id];
          const clickable = canUnlock(n);
          return <g key={n.id} transform={`translate(${n.x},${n.y})`} style={{cursor:clickable?'pointer':'default'}}
            onClick={()=>clickable && unlock(n)}>
            <circle r={4} fill={isUnlocked?'#66cc66':(clickable?'#ffcc00':'#ddd')} stroke="#333" strokeWidth="0.4"/>
            <text x={6} y={2} fontSize="3">{n.title}</text>
          </g>;
        })}
      </svg>
    </div>
  </div>;
}

// Game
function GameArea(){
  const { getFullUser, updateUserData } = useAuth();
  const full = getFullUser();
  const [log,setLog] = React.useState([]);
  const [enemyHp,setEnemyHp]=React.useState(50);
  if(!full) return null;
  const stats = full.profile.stats;
  function addLog(t){ setLog(l=>[t,...l].slice(0,20)); }
  function attack(){
    const dmg = Math.max(1, stats.attack + (Math.random()*5|0));
    setEnemyHp(h=>{
      const nh = Math.max(0,h-dmg);
      addLog(`You hit for ${dmg}. enemy hp ${nh}`);
      if(nh===0){
        addLog('Enemy defeated! +20 XP');
        const newProfile = {...full.profile, xp: full.profile.xp+20};
        updateUserData({profile:newProfile});
      }
      return nh;
    });
  }
  function heal(){
    const amount = 10;
    const newProfile = {...full.profile, stats:{...stats,hp:stats.hp+amount}};
    updateUserData({profile:newProfile});
    addLog(`You healed ${amount} HP`);
  }
  function resetEnemy(){
    setEnemyHp(50+(Math.random()*30|0));
    addLog('New enemy spawned');
  }
  return <div className="game-container">
    <div className="game-hud">
      <div><strong>Player</strong></div>
      <div>HP: {stats.hp}</div>
      <div>Attack: {stats.attack}</div>
    </div>
    <div className="enemy-card">
      <h3>Enemy</h3>
      <div className="enemy-hp">HP: {enemyHp}</div>
      <div className="game-buttons">
        <button onClick={attack} className="btn">Attack</button>
        <button onClick={heal} className="btn">Heal</button>
        <button onClick={resetEnemy} className="btn">New Enemy</button>
      </div>
    </div>
    <div className="game-log">
      <h4>Activity</h4>
      <ul>{log.map((l,i)=><li key={i}>{l}</li>)}</ul>
    </div>
  </div>;
}

// Main App
function App(){
  return <div className="app">
    <nav className="topnav">
      <Link to="/">Home</Link>
      <Link to="/dashboard">Game</Link>
    </nav>
    <Routes>
      <Route path="/" element={<Home/>}/>
      <Route path="/login" element={<Login/>}/>
      <Route path="/signup" element={<Signup/>}/>
      <Route path="/dashboard" element={<ProtectedRoute><Dashboard/></ProtectedRoute>}/>
      <Route path="*" element={<div style={{padding:20}}>Not found</div>}/>
    </Routes>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <BrowserRouter>
      <AuthProvider>
        <App/>
      </AuthProvider>
    </BrowserRouter>
  </React.StrictMode>
);
</script>
</body>
</html>
