<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minecraft Bedrock Blockly / Script Builder — Single File</title>
  <meta name="description" content="Single-file Blockly-based editor to build Minecraft Bedrock scripts, generate manifest.json and export an addon ZIP. Responsive for mobile / tablet / desktop." />
  <style>
    :root{--accent:#4f46e5;--muted:#6b7280}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .app{display:flex;flex-direction:column;height:100vh}
    header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(90deg,#0f172a00,#fff);border-bottom:1px solid #eee}
    header h1{font-size:16px;margin:0}
    .main{display:flex;flex:1;overflow:hidden}
    /* sidebar */
    .sidebar{width:320px;min-width:220px;max-width:420px;border-right:1px solid #eee;display:flex;flex-direction:column;padding:12px;gap:10px;overflow:auto}
    .pane{flex:1;display:flex;flex-direction:column}
    .tabs{display:flex;gap:6px}
    .tab{padding:8px 10px;border-radius:8px;border:1px solid #eee;background:#fafafa;cursor:pointer;font-size:13px}
    .tab.active{background:var(--accent);color:white;border-color:transparent}
    label{font-size:13px;color:var(--muted)}
    input,textarea,select{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    .small-row{display:flex;gap:8px}
    .small-row>input{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}
    .btn.secondary{background:#e6e9ff;color:#0f172a}
    /* workspace */
    .workspace{flex:1;display:flex;flex-direction:column}
    #blocklyDiv{flex:1;height:100%;min-height:320px}
    .footer{display:flex;gap:8px;padding:8px;border-top:1px solid #eee}
    .muted{color:var(--muted);font-size:13px}
    /* responsive */
    @media (max-width:900px){
      .main{flex-direction:column}
      .sidebar{width:100%;max-height:36vh;border-right:0;border-bottom:1px solid #eee}
      header h1{font-size:15px}
    }
  </style>
  <!-- Blocky CDN -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <!-- JSZip & FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24'><rect rx='5' width='24' height='24' fill='%234f46e5'/><text x='12' y='16' font-size='11' font-family='Inter' fill='white' text-anchor='middle'>MC</text></svg>" alt="logo" style="width:36px;height:36px;border-radius:8px;"/>
      <div style="flex:1;display:flex;flex-direction:column">
        <h1>Minecraft Bedrock Script Builder (Single file)</h1>
        <div class="muted">Build scripts with blocks, generate manifest.json and export a behavior pack.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="downloadBtn" class="btn">Download Add-on</button>
        <button id="exportCodeBtn" class="btn secondary">Export JS</button>
      </div>
    </header>

    <div class="main">
      <aside class="sidebar">
        <div class="tabs">
          <div class="tab active" data-tab="build">Build</div>
          <div class="tab" data-tab="docs">Docs</div>
          <div class="tab" data-tab="manifest">Manifest</div>
        </div>

        <div id="build" class="pane">
          <div>
            <label>Workspace name</label>
            <input id="workspaceName" placeholder="MyAddon" value="MyBehaviorPack" />
          </div>
          <div>
            <label>Script entry filename</label>
            <input id="entryFile" value="scripts/main.js" />
          </div>
          <div>
            <label>Code preview</label>
            <textarea id="codePreview" rows="6" readonly style="font-family:monospace;white-space:pre-wrap"></textarea>
          </div>

          <div style="margin-top:6px">
            <label>Quick actions</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="runPreview" class="btn secondary">Generate Code</button>
              <button id="clearWorkspace" class="btn secondary">Clear Blocks</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Examples</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="exampleHello" class="btn">Hello Message</button>
              <button id="exampleTick" class="btn">Periodic Message</button>
            </div>
          </div>
        </div>

        <div id="docs" class="pane" style="display:none">
          <div class="muted">Docs & references (quick links)</div>
          <ul>
            <li><a href="https://aka.ms/startwithmcscript" target="_blank">Microsoft: Getting started with Minecraft scripting</a></li>
            <li><a href="https://wiki.bedrock.dev/scripting/game-tests" target="_blank">Bedrock Wiki: GameTests / scripting</a></li>
            <li><a href="https://jaylydev.github.io/scriptapi-docs/" target="_blank">Script API references (jaylydev)</a></li>
            <li><a href="https://coddyxbox.github.io/manifest_generator/" target="_blank">Manifest generator</a></li>
          </ul>
          <div style="margin-top:8px" class="muted">Tip: These pages were used to make the default manifest & example code.
          </div>
        </div>

        <div id="manifest" class="pane" style="display:none">
          <label>Manifest (generated)</label>
          <div style="margin-top:8px" class="small-row">
            <input id="manifestName" placeholder="Behavior Pack Name" value="My Behavior Pack" />
            <input id="manifestDesc" placeholder="Description" value="Made with the Blockly editor" />
          </div>
          <div style="margin-top:8px" class="small-row">
            <input id="manVerMajor" placeholder="1" value="1" />
            <input id="manVerMinor" placeholder="0" value="0" />
            <input id="manVerPatch" placeholder="0" value="0" />
          </div>
          <div style="margin-top:8px">
            <label>Min engine version (optional)</label>
            <input id="minEngine" placeholder="e.g. 1,20,30" value="1,20,30" />
          </div>
          <div style="margin-top:8px">
            <label>Dependencies (module_name:version) — one per line</label>
            <textarea id="dependencies" rows="3" placeholder='@minecraft/server:1.5.0'>@minecraft/server:1.5.0</textarea>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="regenManifest" class="btn">Regenerate manifest</button>
            <button id="downloadManifest" class="btn secondary">Download manifest.json</button>
          </div>

          <div style="margin-top:10px">
            <label>Manifest JSON</label>
            <textarea id="manifestPreview" rows="8" readonly style="font-family:monospace;white-space:pre-wrap"></textarea>
          </div>
        </div>

      </aside>

      <section class="workspace">
        <div id="blocklyDiv"></div>
        <div class="footer">
          <div class="muted">Workspace: Blockly. Use the toolbox to drag blocks. Output will be generated as JavaScript compatible with Bedrock scripting APIs.</div>
        </div>
      </section>
    </div>
  </div>

  <xml id="toolbox" style="display:none">
    <category name="Logic" colour="#5C81A6">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
    </category>
    <category name="Loops" colour="#5CA65C">
      <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Functions" colour="#8A55D7">
      <block type="procedures_defnoreturn"></block>
      <block type="procedures_callnoreturn"></block>
    </category>
    <category name="Minecraft API" colour="#D67E00">
      <block type="mc_import"/>
      <block type="mc_send_message">
        <value name="MSG"><shadow type="text"><field name="TEXT">Hello from Blockly!</field></shadow></value>
      </block>
      <block type="mc_on_tick"></block>
    </category>
    <category name="Text" colour="#5CA6A6">
      <block type="text"></block>
      <block type="text_join"></block>
    </category>
    <category name="Variables" custom="VARIABLE" colour="#A65C5C"></category>
  </xml>

  <script>
    // --- Initialize Blockly workspace ---
    const blocklyDiv = document.getElementById('blocklyDiv');
    const workspace = Blockly.inject(blocklyDiv, {
      toolbox: document.getElementById('toolbox'),
      scrollbars: true,
      trashcan: true,
      zoom: {controls: true, wheel: true},
      renderer: 'zelos'
    });

    // --- Define simple custom blocks for Minecraft scripting ---
    Blockly.defineBlocksWithJsonArray([
      {
        "type": "mc_import",
        "message0": "import %1 from %2",
        "args0": [
          {"type":"field_input","name":"NAMES","text":"{ world, system }"},
          {"type":"field_input","name":"MODULE","text":"\"@minecraft/server\""}
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 230,
        "tooltip": "Import classes from module",
        "helpUrl": ""
      },
      {
        "type": "mc_send_message",
        "message0": "world.sendMessage %1",
        "args0": [{"type":"input_value","name":"MSG"}],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 160
      },
      {
        "type": "mc_on_tick",
        "message0": "on tick do %1",
        "args0": [{"type":"input_statement","name":"DO"}],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 20
      }
    ]);

    // --- Generators to JS ---
    Blockly.JavaScript['mc_import'] = function(block) {
      const names = block.getFieldValue('NAMES') || '{ }';
      const module = block.getFieldValue('MODULE') || '"@minecraft/server"';
      const code = `import ${names} from ${module};\n`;
      return code;
    };

    Blockly.JavaScript['mc_send_message'] = function(block) {
      const msg = Blockly.JavaScript.valueToCode(block, 'MSG', Blockly.JavaScript.ORDER_ATOMIC) || '"Hello"';
      return `world.sendMessage(${msg});\n`;
    };

    Blockly.JavaScript['mc_on_tick'] = function(block) {
      const statements = Blockly.JavaScript.statementToCode(block, 'DO');
      const funcName = 'mainTick';
      const code = `function ${funcName}() {\n${statements}}\n system.run(${funcName});\n`;
      return code;
    };

    // Use default generators for other blocks

    // --- UI behavior ---
    function updateCodePreview(){
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      document.getElementById('codePreview').value = code;
      return code;
    }

    document.getElementById('runPreview').addEventListener('click', ()=>{
      updateCodePreview();
    });

    document.getElementById('exportCodeBtn').addEventListener('click', ()=>{
      const code = updateCodePreview();
      const blob = new Blob([code], {type:'text/javascript'});
      saveAs(blob, 'main.js');
    });

    document.getElementById('clearWorkspace').addEventListener('click', ()=>{
      workspace.clear();
      updateCodePreview();
    });

    document.getElementById('exampleHello').addEventListener('click', ()=>{
      workspace.clear();
      const xml = `<xml><block type="mc_import" x="10" y="10"><field name="NAMES">{ world }</field><field name="MODULE">\"@minecraft/server\"</field></block><block type="mc_send_message" x="10" y="120"><value name="MSG"><shadow type="text"><field name="TEXT">Hello from Blockly!</field></shadow></value></block></xml>`;
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), workspace);
      updateCodePreview();
    });

    document.getElementById('exampleTick').addEventListener('click', ()=>{
      workspace.clear();
      const xml = `<xml><block type="mc_import" x="10" y="10"><field name="NAMES">{ world, system }</field><field name="MODULE">\"@minecraft/server\"</field></block><block type="mc_on_tick" x="10" y="120"><statement name="DO"><block type="controls_if"><value name="IF0"><block type="logic_compare"><field name="OP">EQ</field><value name="A"><block type="math_arithmetic"><field name="OP">MOD</field><value name="A"><block type="system_currentTick_proxy"></block></value><value name="B"><shadow type="math_number"><field name="NUM">200</field></shadow></value></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block></value><statement name="DO0"><block type="mc_send_message"><value name="MSG"><shadow type="text"><field name="TEXT">Tick message!</field></shadow></value></block></statement></block></statement></block></xml>`;
      try{ Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), workspace);}catch(e){console.warn(e)}
      updateCodePreview();
    });

    // small helper block used by exampleTick (proxy to current tick) - create a simple generator and block
    Blockly.defineBlocksWithJsonArray([{type:'system_currentTick_proxy',message0:'system.currentTick',output:null,colour:65}]);
    Blockly.JavaScript['system_currentTick_proxy']=function(){return ['system.currentTick',Blockly.JavaScript.ORDER_ATOMIC];};

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      document.querySelectorAll('.pane').forEach(p=>p.style.display='none');
      document.getElementById(tab).style.display='flex';
    }));

    // --- Manifest generation ---
    function makeUUID(){
      // Use crypto if available
      if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
      // fallback simple uuidv4
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});
    }

    function parseVersionFields(){
      const maj = parseInt(document.getElementById('manVerMajor').value)||1;
      const min = parseInt(document.getElementById('manVerMinor').value)||0;
      const pat = parseInt(document.getElementById('manVerPatch').value)||0;
      return [maj,min,pat];
    }

    function generateManifest(){
      const headerUuid = makeUUID();
      const moduleUuid = makeUUID();
      const name = document.getElementById('manifestName').value || 'My Behavior Pack';
      const desc = document.getElementById('manifestDesc').value || '';
      const version = parseVersionFields();
      const minEngineRaw = document.getElementById('minEngine').value.trim();
      const minEngine = minEngineRaw ? minEngineRaw.split(',').map(s=>parseInt(s.trim())||0) : undefined;
      const depsText = document.getElementById('dependencies').value.trim();
      const deps = depsText ? depsText.split('\n').map(l=>{ const [module,ver]=l.split(':'); return {module_name:module.trim(), version:ver?ver.trim():""}}) : [];

      const modules = [
        {
          description: name + " data module",
          type: "data",
          uuid: moduleUuid,
          version: [1,0,0]
        },
        {
          description: "Script module",
          type: "script",
          uuid: makeUUID(),
          version: [1,0,0],
          entry: document.getElementById('entryFile').value || 'scripts/main.js'
        }
      ];

      const manifest = {
        format_version: 2,
        header: {
          description: desc,
          name: name,
          uuid: headerUuid,
          version: version,
          min_engine_version: minEngine
        },
        modules: modules,
        dependencies: deps
      };
      return manifest;
    }

    function updateManifestPreview(){
      const obj = generateManifest();
      document.getElementById('manifestPreview').value = JSON.stringify(obj, null, 2);
      return obj;
    }

    document.getElementById('regenManifest').addEventListener('click', ()=>{
      updateManifestPreview();
    });

    document.getElementById('downloadManifest').addEventListener('click', ()=>{
      const json = JSON.stringify(generateManifest(),null,2);
      const blob = new Blob([json],{type:'application/json'});
      saveAs(blob,'manifest.json');
    });

    // Auto-generate on load
    updateManifestPreview();

    // --- Create addon ZIP ---
    async function createAddonZip(){
      updateCodePreview();
      const code = document.getElementById('codePreview').value || '';
      const manifestObj = generateManifest();
      const wpName = (document.getElementById('workspaceName').value||'MyBehaviorPack').replace(/[^a-zA-Z0-9_-]/g,'_');

      const zip = new JSZip();
      // behavior_pack folder
      const bp = zip.folder(wpName);
      bp.file('manifest.json', JSON.stringify(manifestObj, null, 2));
      // scripts folder
      bp.file(document.getElementById('entryFile').value || 'scripts/main.js', code);

      // optional README
      bp.file('README.txt', 'Generated with Minecraft Bedrock Blockly Editor (single file)');

      const content = await zip.generateAsync({type:'blob'});
      saveAs(content, `${wpName}_behavior_pack.zip`);
    }

    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      createAddonZip();
    });

    // Generate initial sample import so code preview isn't empty
    setTimeout(()=>{
      document.getElementById('exampleHello').click();
    },300);

    // --- End ---
  </script>
</body>
</html>
